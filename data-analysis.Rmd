---
title: "Traffic Data Analysis"
output: html_document
---

# Needed Libraries

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(ggplot2)
library(dplyr)
library(knitr)
library(stargazer)
library(MASS)
library(pracma)
library(tidyr)
```

# Data Processing

```{r, tidy=TRUE, cache=TRUE}
be2olak.data <- read.csv("all-semi-unique.csv")
summary(be2olak.data)
str(be2olak.data)
```

```{r, tidy=TRUE, cache=TRUE}
#duplicated.rows <- be2olak.data[ which(be2olak.data$rd.rp.cmid == 9344516), ]
#duplicated.rows
```

***

## Removing not needed columns

By analyzing the distribution of some columns, I found that some of the columns only have one value, so these columns are not needed and should be deleted from the data.


The columns that will be deleted are the following:

* ad.aid
* ad.bgcl
* ad.bgcls
* ad.fncl
* ad.fncls
* ad.lid
* ad.logo
* ad.logo2x
* ad.logoAndroidS
* ad.logoAndroidH
* ad.cm
* ad.url
* ad.g
* rd.cl
* rd.rp.type

***

```{r, tidy=TRUE, cache=TRUE}
col_ct = sapply(be2olak.data, function(x) length(unique(x)))
print(col_ct)
#be2olak.data <- subset(be2olak.data, select=-c(2:14,22,34))
be2olak.data <- be2olak.data[, !names(be2olak.data) %in% names(col_ct[col_ct==1])]
```

Moreover, the 6 columns (rd.stid, rd.hr, rd.mn, ) are meaningless so I will remove them:

```{r, tidy=TRUE, cache=TRUE}
col_ct = c("rd.stid", "rd.hr", "rd.mn", "rd.rp.fullnm", "rd.img", "rd.rp.img")
print(col_ct)
```

```{r, tidy=TRUE, cache=TRUE}
print(!names(be2olak.data) %in% col_ct)
be2olak.data <- be2olak.data[, !names(be2olak.data) %in% col_ct]
```

```{r, tidy=TRUE, cache=TRUE}
##nrow(be2olak.data) - length(is.na(be2olak.data$rd.img))
#sum(is.na(be2olak.data$rd.img))
#nrow(be2olak.data)
#be2olak.data[!is.na(be2olak.data$rd.img),]
```

```{r, tidy=TRUE, cache=TRUE}
summary(be2olak.data)
str(be2olak.data)
```

```{r, tidy=TRUE, cache=TRUE}
be2olak.data[duplicated(be2olak.data[,2:ncol(be2olak.data)]),]
stargazer(be2olak.data, type = "text", title = "Descriptive statistics")
```

The proportion of NAs:

```{r, tidy=TRUE, cache=TRUE}
length(be2olak.data[is.na(be2olak.data)])/(ncol(be2olak.data)*nrow(be2olak.data)) 
#barplot(sapply(be2olak.data, function(col) sum(is.na(col))))
```

***

## Removing Duplicated Rows


```{r, tidy=TRUE, cache=TRUE}
nrow(unique(be2olak.data[c("crawl_date", "rd.rp.stid", "rd.rp.cmid")]))
nrow(unique(be2olak.data[c("rd.rp.stid", "rd.rp.cmid")]))
nrow(unique(be2olak.data[c("rd.rp.cmid")]))
#dups <- duplicated(be2olak.data[,c(1,15,17)])
#print(dups)
#be2olak.data <- be2olak.data[!duplicated(be2olak.data[,which( colnames(be2olak.data)=="rd.rp.cmid" )]),]
```

Remove duplicated comments:
```{r, tidy=TRUE, cache=TRUE}
dim(be2olak.data)
#be2olak.data <- be2olak.data[!duplicated(be2olak.data[,which( colnames(be2olak.data)=="rd.rp.cmid" )]),]
be2olak.data <- be2olak.data[!duplicated(be2olak.data[,which( colnames(be2olak.data) %in% c("rd.rp.cmid", "rd.rp.stid") )]),]
dim(be2olak.data)
```


```{r, tidy=TRUE, cache=TRUE}
strq.cmrq <- be2olak.data[which(be2olak.data$rd.strq == be2olak.data$rd.cmrq),]
nrow(strq.cmrq)
head(strq.cmrq[,c(2:13)])
```

```{r, tidy=TRUE, cache=TRUE}
unique.cmid <- aggregate(rd.rp.stid ~ rd.rp.cmid, be2olak.data, length)
duplicated.cmid <- unique.cmid[ which(unique.cmid$rd.rp.stid > 1), ]
head(duplicated.cmid)
tail(duplicated.cmid)
```


```{r, tidy=TRUE, cache=TRUE}
duplicated.cmid.vector <- rbind(duplicated.cmid$rd.rp.cmid)
#print(duplicated.cmid.vector)
duplicated.rows <- be2olak.data[ which(be2olak.data$rd.rp.cmid %in% duplicated.cmid.vector), ]
nrow(duplicated.rows[!duplicated.rows$rd.rp.nm %in% c("bey2ollakgps"),])
```

From above we reached that duplicated rows are only existing when rd.rp.nm is "be2ollakgps"


```{r, tidy=TRUE, cache=TRUE}
stid10.percentage <- nrow(duplicated.rows[which(duplicated.rows$rd.rp.stid == 10),]) * 100.0/ nrow(duplicated.rows)
print(stid10.percentage)
```

Check data summary again after removing the duplicated rows:
```{r, tidy=TRUE, cache=TRUE}
stargazer(be2olak.data, type = "text", title = "Descriptive statistics")
summary(be2olak.data)
str(be2olak.data)
```


The proportion of NAs:

```{r, tidy=TRUE, cache=TRUE}
length(be2olak.data[is.na(be2olak.data)])/(ncol(be2olak.data)*nrow(be2olak.data)) 
```

```{r, tidy=TRUE, cache=TRUE}
col_ct = sapply(be2olak.data, function(x) length(unique(x)))
print(col_ct)
be2olak.data <- be2olak.data[, !names(be2olak.data) %in% names(col_ct[col_ct==1])]
```

Get the most frequent strings in comments column

```{r, tidy=TRUE, cache=TRUE}
freqfunc <- function(x, n){
  tail(sort(table(unlist(strsplit(as.character(x), ", ")))), n)
}
freqfunc(be2olak.data$rd.rp.cm, 10)
```

***

## Plotting graphs for the different columns

```{r, tidy=TRUE, cache=TRUE}
status <- be2olak.data$rd.rp.stid
status.freq <- table(status)
print(status.freq)
str(status.freq)
barplot(status.freq)
```

```{r, tidy=TRUE, cache=TRUE}
hist(status,xlab = "Comment status")
```

```{r, tidy=TRUE, cache=TRUE}
stid.nas <- sum(is.na(be2olak.data$rd.rp.stid))
print(stid.nas)
stid.nas/(nrow(be2olak.data)) 
ggplot(be2olak.data) + geom_bar(aes(x=rd.rp.stid), fill="gray")
```

By Montoring Be2ollak website, I was able to find most of those status look like:

* 1 --> :D
* 2 --> :)
* 3 --> :|
* 4 --> :(
* 5 --> :'(
* 6 --> ?
* 7 --> Danger Skull
* 10 --> lamb

However, 8 and 9 were difficult to find in the feed.


```{r, tidy=TRUE, cache=TRUE}
#write.csv(be2olak.data, file = "MyData.csv",row.names=FALSE)
```

***

## Feature Engineering

### Format Crawl Date in a better way

```{r, tidy=TRUE, cache=TRUE}
new.data <- be2olak.data %>% separate(crawl_date, c("Week_day", "Month", "Month_day", "Crawl_date"), extra = "drop", sep = "[ ]+", convert = TRUE, remove = TRUE) %>% unite(Crawl.time, Week_day, Month, Month_day, Crawl_date, sep = " ", remove = FALSE)
summary(new.data)
str(new.data)
new.data$formated.date <- as.POSIXct(strptime(new.data$Crawl.time, format="%a %b %d %H:%M:%S"))
str(new.data)
summary(new.data)
#new.data$Crawl_date <- as.Date(as.character(new.data$Crawl_date))
#str(new.data)
```

***

### Get Comment's Actual Time



***

```{r, eval=F, tidy=TRUE, cache=TRUE}
library(rmarkdown)
render("data-analysis.Rmd")
```
